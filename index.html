<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>PS1 Horror FPS</title>
<style>
body{margin:0;overflow:hidden;background:black}
canvas{display:block;image-rendering:pixelated}
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");

function resize(){
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;
}
resize();
window.addEventListener("resize",resize);

/* ===== TEXTURES ===== */
const wallTex=new Image();
wallTex.src="wall.png";

const enemySprites=[];
for(let i=0;i<8;i++){
let img=new Image();
img.src=`enemy_${i}.png`;
enemySprites.push(img);
}

/* ===== MAP ===== */
const map=[
"111111111111111",
"100000000000001",
"101111011111101",
"100001010000001",
"111101010111101",
"100001000100001",
"101111110101101",
"100000000000001",
"111111111111111"
];

function isWall(x,y){
let mx=Math.floor(x);
let my=Math.floor(y);
if(my<0||my>=map.length||mx<0||mx>=map[0].length) return true;
return map[my][mx]=="1";
}

/* ===== PLAYER ===== */
let player={x:2,y:2,angle:0};
let keys={};

document.addEventListener("keydown",e=>keys[e.key]=true);
document.addEventListener("keyup",e=>keys[e.key]=false);

canvas.addEventListener("click",()=>{
canvas.requestPointerLock();
});

document.addEventListener("mousemove",e=>{
if(document.pointerLockElement===canvas){
player.angle+=e.movementX*0.002;
}
});

/* ===== ENEMY ===== */
function createEnemy(){
return{
x:6,
y:6,
dir:0
};
}

let enemies=[createEnemy()];

/* ===== UPDATE ===== */
function update(){
let speed=0.05;
let nx=player.x;
let ny=player.y;

if(keys["w"]){ nx+=Math.cos(player.angle)*speed; ny+=Math.sin(player.angle)*speed;}
if(keys["s"]){ nx-=Math.cos(player.angle)*speed; ny-=Math.sin(player.angle)*speed;}
if(keys["a"]){ nx+=Math.cos(player.angle-Math.PI/2)*speed; ny+=Math.sin(player.angle-Math.PI/2)*speed;}
if(keys["d"]){ nx+=Math.cos(player.angle+Math.PI/2)*speed; ny+=Math.sin(player.angle+Math.PI/2)*speed;}

if(!isWall(nx,player.y)) player.x=nx;
if(!isWall(player.x,ny)) player.y=ny;

/* 敵の向き更新 */
enemies.forEach(e=>{
let dx=player.x-e.x;
let dy=player.y-e.y;
e.dir=Math.atan2(dy,dx);
});
}

/* ===== RENDER ===== */
function render(){

ctx.fillStyle="#000";
ctx.fillRect(0,0,canvas.width,canvas.height);

let rays=320;
let fov=Math.PI/3;

for(let i=0;i<rays;i++){

let angle=player.angle-fov/2+(i/rays)*fov;
let dist=0;

while(dist<20){
let rx=player.x+Math.cos(angle)*dist;
let ry=player.y+Math.sin(angle)*dist;
if(isWall(rx,ry)) break;
dist+=0.02;
}

let wallH=canvas.height/(dist+0.1);
let wallX=i*(canvas.width/rays);

/* テクスチャ描画 */
let hitX=player.x+Math.cos(angle)*dist;
let hitY=player.y+Math.sin(angle)*dist;

let texX=(hitX%1)*wallTex.width;

ctx.drawImage(
wallTex,
texX,0,1,wallTex.height,
wallX,
(canvas.height/2)-(wallH/2),
canvas.width/rays+1,
wallH
);
}

/* ===== ENEMY RENDER ===== */
enemies.forEach(e=>{

let dx=e.x-player.x;
let dy=e.y-player.y;
let dist=Math.hypot(dx,dy);
let ang=Math.atan2(dy,dx)-player.angle;
ang=(ang+Math.PI*3)%(Math.PI*2)-Math.PI;

if(Math.abs(ang)<fov/2){

let size=canvas.height/(dist);
let screenX=(ang/(fov/2))*canvas.width/2+canvas.width/2;

/* 8方向計算 */
let relative=e.dir-player.angle;
relative=(relative+Math.PI*3)%(Math.PI*2);

let index=Math.floor((relative/(Math.PI*2))*8);
index=(index+8)%8;

ctx.drawImage(
enemySprites[index],
screenX-size/2,
canvas.height/2-size/2,
size,
size
);
}
});
}

/* LOOP */
function loop(){
update();
render();
requestAnimationFrame(loop);
}
loop();

</script>
</body>
</html>